<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jhta.yr.mybatis.mapper.DepositMapper">
	
	<sql id="sestatusKinds">
		<if test="@com.jhta.finalproject.yr.mybatischeck.MybatisCheck@notEmpty(sestatus)">
			and sestatus = #{sestatus}
		</if>
		
	</sql>
	
	<sql id = "search">
		<!-- 주문일, 접수일 -->
		<if test="@com.jhta.finalproject.yr.mybatischeck.MybatisCheck@notEmpty(tfield)">
			 and TRUNC(${tfield}) BETWEEN TO_DATE(#{startDate}) AND TO_DATE(#{endDate})
		</if>
		<!-- 		처리상태 -->
		<if test="@com.jhta.finalproject.yr.mybatischeck.MybatisCheck@notEmpty(status)">
			and sestatus in
			<foreach collection="status" item="bs" open="(" close=")" separator=",">
				<if test="status != -1">
				#{bs,jdbcType=VARCHAR}	
				</if>
			</foreach>
		</if>
		
		<!-- 	    회원상태 -->
		<if test="@com.jhta.finalproject.yr.mybatischeck.MybatisCheck@notEmpty(mType)">
			<if test="mType == 2">
				and bpayment.mnum = 0  						
			</if>						
			<if test="mType == 1">
				and bpayment.mnum != 0  						
			</if>				
	    </if>
	</sql>

	<select id="settlementList" resultType="SettlementJoinVo" parameterType="hashmap" >
		select * from settlement, account, members where settlement.anum = account.anum and account.mnum = members.mnum
		<include refid="sestatusKinds"/>
		<include refid="search"/>
		 order by sestatus, appdate
	</select>
	
	<update id = "updateSestatus" parameterType="int">
		update settlement set sestatus = 1,  comdate = sysdate where senum = #{senum}
	</update>
	
	<insert id="decreaseDeposit" parameterType="hashmap">
		insert into deposit values (SEQ_DEPOSIT_DNUM.nextval, #{mnum}, null, #{dtran}, sysdate, 3)
	</insert>

</mapper>