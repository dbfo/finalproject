<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mybatis.mapper.OrderMapper">
	<!--//////////// 주문완료 관련 트랜잭션 DML 시작 ////////////-->
		
		<!-- 주문결제 테이블에 추가 ((카드결제 )) -->
		<insert id="bpayment" parameterType="hashmap">
			insert into bpayment values(SEQ_bpayment_bpaynum.nextval,#{shipaddr},#{callnum},#{pay_price_noshipfee},
											sysdate,sysdate,
											<choose>
											<when test="method=='card'">1</when>
											<otherwise>0</otherwise>
											</choose>
											,#{orderprice},#{usepoint},
											<choose>
											<when test="method=='card'">0</when>
											<otherwise>1</otherwise>
											</choose>
										    ,#{receiver},#{shipCharge},#{mnum})
		</insert>
		<!-- 방금 추가한 데이터 주문번호 가져오기. -->
		<select id="getbpayNum" resultType="int">
			select SEQ_bpayment_bpaynum.currval from dual
		</select>
		
		<!-- 해당주문의 주문한책데이터 추가. -->
		<insert id="paymentbook" parameterType="hashmap">
			insert into paymentbook values(#{bpaynum},1,#{bnum},#{bcount},#{point},SEQ_paymentbook_num.nextval)
		</insert>
		<!-- 새책테이블에서 원래 수량 구하기 -->
		<select id="books_bcount" parameterType="hashmap" resultType="int">
			select bcount from books where bnum=#{bnum}
		</select>
		<!-- 새책테이블에서 수량변경  -->
		<update id="change_count" parameterType="hashmap">
			update books set bcount=#{changebcount} where bnum=#{bnum}
		</update>
		
		<!-- 포인트사용 -->
		<insert id="use_point" parameterType="hashmap">
			insert into point values(#{mnum},#{bpaynum},#{usedpoint},sysdate)
		</insert>
		
		<!-- 포인트적립 -->
		<insert id="point_plus" parameterType="hashmap">
			insert into point values(#{mnum},#{bpaynum},#{totalpoint},sysdate)
		</insert>
		
		<!-- 주문/결제완료후 장바구니 존재시 장바구니에서 삭제 -->
		<delete id="delete_cart" parameterType="hashmap">
			delete from cart where cartnum in
			<foreach collection="cartNum" item="item" index="index" open="(" close=")" separator=",">
				#{item}
			</foreach>
		</delete>
		<!-- 가상계좌 선택시 가상계좌테이블에 계좌정보 입력. -->
		<insert id="vbank" parameterType="hashmap">
			insert into vbank values(#{bpaynum},#{vbank_name},#{vbank_num},#{vbank_holder})
		</insert>		
		
	<!--//////////// 주문완료 관련 트랜잭션 DML 끝 /////////////-->
	
	<!-- 중고상품 장바구니->주문페이지 SELECT 문 -->
	<select id="usedorderlist" parameterType="hashmap" resultType="usedOrderVo">
		select cartnum,cart.bnum,cart.btype,cart.bcount,obname,obstatus,oborgprice,obsaleprice,obdelfee,members.mid sid,members.mnum smnum,imgsavefilename from 
		(select * from cart where btype=2 and cartnum in
			<foreach collection="datalist" item="item" index="index" open="(" close=")" separator=",">
				#{item}
			</foreach>
		)cart,
		(select * from oldbooks)ob,
		(select * from obseller)obs,
		(select * from img where btype=2 and thumbnail=1) img,
		(select * from members) members 
		where cart.bnum=ob.obnum and cart.bnum=img.bnum and ob.snum=obs.snum and obs.mnum=members.mnum
		order by sid desc
	</select>
 	<!-- 장바구니 -> 주문페이지 갈때 사용하는 SELECT 문  -->
	<select id="orderlist" parameterType="hashmap" resultType="orderVo">
		select btitle,book.bnum,bprice,bpoint, imgsavefilename,cartNum,cart.bcount from
		(select * from cart where btype=1 and cartnum in
		<foreach collection="datalist" item="item" index="index" open="(" close=")" separator=",">
			#{item}
		</foreach>
		)cart,
		(select * from books) book,
		(select * from img where THUMBNAIL=1 and btype=1)img
		where cart.bnum=book.bnum and book.bnum=img.bnum
	</select>
	<!-- 상품페이지,리스트에서 바로 구매하기 버튼 클릭 -->
	<select id="directorder" parameterType="int" resultType="orderVo">
		select btitle,book.bnum,bprice,bpoint,imgsavefilename from
		(select * from books) book,(select * from img where thumbnail=1 and btype=1)img
		where book.bnum=img.bnum and book.bnum=#{bnum}
	</select>
	<!-- 주문페이지에서 배송지 SELECT 함 -->
	<select id="getAddr" parameterType="int" resultType="shipVo">
		select addr,phone,mname,mnum from members where mnum=#{mnum}
	</select>
	
	<!-- 주문페이지에서 사용가능한 포인트 -->
	<select id="usablepoint" parameterType="int" resultType="int">
		select nvl(sum(tranpoint),0) from point where mnum=#{mnum}
	</select>
</mapper>

