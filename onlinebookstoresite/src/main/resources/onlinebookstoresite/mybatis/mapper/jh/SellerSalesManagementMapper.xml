<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jhta.mybatis.mapper.SellerSalesManagementMapper.jh">
	<!-- //*판매관리 관련 Mapper설정파일*// -->
	
	<!-- 검색조건 -->
	<sql id="search">
		<if test="startDay!=null and startDay!=''">
			<![CDATA[
				and borderdate >= to_date(#{startDay},'yyyy-mm-dd') and borderdate <= to_date(#{endDay},'yyyy_mm_dd')+0.99999
			]]>
		</if>
		<if test="obname!=null">
			and o.obname like '%'||#{keyword1,jdbcType=VARCHAR}||'%'
		</if>
		<if test="mname!=null and mname !=''">
			and m.mname like '%'||#{keyword1,jdbcType=VARCHAR}||'%'
		</if>
		<if test="receiver!=null and receiver !=''">
			and bp.receiver like '%||#{keyword1,jdbcType=VARCHAR}||%'
		</if>
	</sql>
	
	<resultMap type="obsalesjoin" id="obsalesjoin">
		<result column="bpaynum" property="bpaynum"/>
		<result column="snum" property="snum"/>
		<result column="btype" property="btype"/>
		<result column="bcount" property="bcount"/>
		<result column="baddr" property="baddr"/>
		<result column="phone" property="phone"/>
		<result column="bfinalmoney" property="bfinalmoney"/>
		<result column="borderdate" property="borderdate"/>
		<result column="bpaydate" property="bpaydate"/>
		<result column="bstatus" property="bstatus"/>
		<result column="ordermoney" property="ordermoney"/>
		<result column="mothodpayment" property="mothodpayment"/>
		<result column="receiver" property="receiver"/>
		<result column="mnum" property="mnum"/>
		<result column="delfee" property="delfee"/>
		<result column="mname" property="mname"/>
		<result column="obnum" property="obnum"/>
		<collection property="sellerOldbooksVo"	ofType="oldbooks">
			<result property="obname" column="obname"/>
			<result property="obsaleprice" column="obsaleprice"/>
		</collection>
	</resultMap>
	<!-- 리스트 가져오기 -->
	<select id="getSalesList" parameterType="hashmap" resultMap="obsalesjoin">
		    select * from(
	            select b.bpaynum BPAYNUM, o.SNUM SNUM, p.BTYPE BTYPE, p.BCOUNT BCOUNT, 
                    b.BADDR BADDR, b.BPHONE BPHONE, b.BFINALMONEY BFINALMONEY, b.BORDERDATE BORDERDATE, b.BPAYDATE BPAYDATE, 
                    b.BSTATUS BSTATUS, b.ORDERMONEY ORDERMONEY, b.MOTHODPAYMENT MOTHODPAYMENT, b.RECEIVER RECEIVER, 
                    b.MNUM MNUM, b.DELFEE DELFEE,m.mname MNAME, o.obname OBNAME,o.obsaleprice OBSALEPRICE
	                from paymentbook p,( select * from
                    (
                    select * from(
                        select a.*,rownum r from
                        (
                            select *
                            from bpayment where bpaynum in 
                             (select distinct(pay) from (
                                select bp.bpaynum pay from 
                                bpayment b,oldbooks o,paymentbook bp,members m 
                                where o.snum=#{snum} and b.bstatus=#{bstatus} and b.bpaynum=bp.bpaynum 
                                and bp.bnum=o.obnum and m.mnum=b.mnum
                                <include refid="search"></include>
                                order by b.borderdate desc  
                             ) 
                           )
                        )a
	    <![CDATA[
                    )where r>=#{startRow} and r<=#{endRow} ) )b, oldbooks o,members m 
	            where b.bpaynum=p.bpaynum and p.btype=2 and p.bnum=o.obnum and b.mnum=m.mnum     
	           )
		]]>
	</select>
	
	<!-- 페이징처리:전체 행 -->
	<select id="getTotRowCount" parameterType="hashmap" resultType="int">
		select count(DISTINCT(b.bpaynum)) count 
		from bpayment b, paymentbook bp, oldbooks o, members m 
		where b.bpaynum=bp.bpaynum and bp.bnum=o.obnum and b.mnum=m.mnum and snum=#{snum} and b.bstatus=#{bstatus}
		<include refid="search"></include>
	</select>
	
	
	
	
	
	
	<!--  
	<select id="getTotRowCount" parameterType="hashmap" resultMap="obsalesjoin">
		select a.*,rownum rnum
			from(
	            select b.bpaynum BPAYNUM, o.SNUM SNUM, p.BTYPE BTYPE, p.BCOUNT BCOUNT, 
	            b.BADDR BADDR, b.BPHONE BPHONE, b.BFINALMONEY BFINALMONEY, b.BORDERDATE BORDERDATE, b.BPAYDATE BPAYDATE, 
	            b.BSTATUS BSTATUS, b.ORDERMONEY ORDERMONEY, b.MOTHODPAYMENT MOTHODPAYMENT, b.RECEIVER RECEIVER, 
	            b.MNUM MNUM, b.DELFEE DELFEE,m.mname MNAME, o.obname OBNAME,o.obsaleprice OBSALEPRICE
	            from paymentbook p,bpayment b, oldbooks o,members m
	            where b.bpaynum=p.bpaynum and p.btype=2 and p.bnum=o.obnum and b.mnum=m.mnum and snum=#{snum} and b.bstatus=#{bstatus}
	            order by borderdate desc)a
	</select>
	
	-->
	<!-- 
	<resultMap type="int" id="obsalesjoin">
		<result column="count" property="count"/>
		<collection property="sellerOldbooksVo"	ofType="oldbooks">
			<result property="obname" column="obname"/>
			<result property="obsaleprice" column="obsaleprice"/>
		</collection>
	</resultMap>
	 -->

	<!-- 전체 행의 갯수 구하기 
	<select id="getTotRowcount" parameterType="hashmap" resultType="int">
		select count(*) count 
		from(
			select b.bpaynum BPAYNUM, o.SNUM SNUM, p.BTYPE BTYPE, p.BCOUNT BCOUNT,
			b.BADDR BADDR, b.BPHONE BPHONE, b.BFINALMONEY BFINALMONEY, b.BORDERDATE BORDERDATE, 
			b.BPAYDATE BPAYDATE, b.BSTATUS BSTATUS, b.ORDERMONEY ORDERMONEY, b.MOTHODPAYMENT MOTHODPAYMENT, 
			b.RECEIVER RECEIVER, b.MNUM MNUM, b.DELFEE DELFEE,m.mname MNAME, o.obname OBNAME, o.obsaleprice OBSALEPRICE 
			from paymentbook p,bpayment b, 
			oldbooks o,members m
			where b.bpaynum=p.bpaynum and p.btype=2 and p.bnum=o.obnum and b.mnum=m.mnum and snum=1 and b.bstatus=0 order by borderdate desc)a
	</select> 
 
 -->
 
 
 
 
 
 
	<!-- 중고판매관리(0:입금대기중)
	<select id="getSalesList" parameterType="hashmap" resultType="obsalesjoin">
		select a.*,rownum rnum
		from(
            select DISTINCT b.bpaynum BPAYNUM, o.SNUM SNUM, p.BTYPE BTYPE, p.BCOUNT BCOUNT, 
            b.BADDR BADDR, b.BPHONE BPHONE, b.BFINALMONEY BFINALMONEY, b.BORDERDATE BORDERDATE, b.BPAYDATE BPAYDATE, 
            b.BSTATUS BSTATUS, b.ORDERMONEY ORDERMONEY, b.MOTHODPAYMENT MOTHODPAYMENT, b.RECEIVER RECEIVER, 
            b.MNUM MNUM, b.DELFEE DELFEE,m.mname MNAME
            from paymentbook p,bpayment b, oldbooks o,members m
            where b.bpaynum=p.bpaynum and p.btype=2 and p.bnum=o.obnum and b.mnum=m.mnum and snum=#{snum} and b.bstatus=#{bstatus}
            order by borderdate desc)a
	</select>
-->
</mapper>